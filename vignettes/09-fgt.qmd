---
title: "Testing random access to the data performance"
editor: source
---

```{r}
pkgload::load_all()
library(microbenchmark)
library(bench)
```

## Read random countries/years/areas/genders/ages from the data

```{r eval=FALSE}
library(purrr)
library(arrow)
library(dplyr, warn.conflicts = FALSE)
library(DBI)
library(duckdb)
library(dbplyr)
library(duckplyr)
library(here)
library(glue)

source(here("R/fgt0.R"))

pqt_fldr <- here("data-testing")
# pqt_path <- file.path(pkt_fldr, from_pkt, "**/*.parquet")
duck_fldr <- here("data-testing-duck")

from_files <- list.dirs(pqt_fldr, recursive = FALSE, full.names = F) |> sort()


# Load data
dta <-
  here("data-testing", from_files[[2]]) |>
  arrow::open_dataset() |>
  collect()


library(data.table)
library(collapse)

# Collapse to get poverty measures
get_fgt_collapse <- \(x) {
  x |>
    fgroup_by(country, year) |>
    fsummarise(
      fgt0 = fgt_collapse(welfare, weight, alpha = 0),
      fgt1 = fgt_collapse(welfare, weight, alpha = 1),
      fgt2 = fgt_collapse(welfare, weight, alpha = 2)
    )
}

# Data table to get poverty measures
get_fgt_DT <- \(x) {
  x[,
    .(
      fgt0 = fgt_collapse(welfare, weight, alpha = 0),
      fgt1 = fgt_collapse(welfare, weight, alpha = 1),
      fgt2 = fgt_collapse(welfare, weight, alpha = 2)
    ),
    keyby = .(country, year)
  ]
}

get_fgt_DT(copy(qDT(dta)))
get_fgt_DT(copy(qDT(dta)))


# Dplyr
get_fgt_dplyr <- function(dta, povline = 0.1) {
  dta  |>
  mutate(
    poor = as.integer(welfare <= povline),
    hc = poor * weight
  ) |> 
  summarise(
    hc0 = sum(hc),
    ftg0 = sum(hc) / sum(weight),
    ftg1 = sum(poor * (povline - welfare) * weight) / sum(weight) / povline,
    .groups = "drop"
  ) |> 
  mutate(ftg2 = ftg1 ^ 2) |> 
  select(country, year, hc = hc0, ftg0, ftg1, ftg2)
}


pl <-  collapse::fmedian(dta$welfare, w = dta$weight)/2

dta |> group_by(country, year) |> get_fgt_dplyr(pl)


# here("data-testing") |> 
#   list.dirs(recursive = FALSE) |>
#   purrr::walk(
#     ~ {
#       dta <- arrow::open_dataset(.x) |> collect() |> qDT()
#       # gg <- dta |> fgroup_by(country, year)
#       setkey(dta, country, year)
#       setindex(dta, country, year, area, gender, age)

#       md_out <-
#         bench::mark(
#           get_fgt_collapse(dta),
#           get_fgt_DT(copy(dta)),
#           iterations = 3,
#           check = FALSE
#         )
#       cat("\n\n\n")
#       cat(.x, "\n")
#       print(md_out |> select(expression,  min, median, mem_alloc))
#     }
#   )

```


```
C:/Users/wb532966/eb-local/povspark/data-testing/sample_00001k 
# A tibble: 2 × 4
  expression                 min   median mem_alloc
  <bch:expr>            <bch:tm> <bch:tm> <bch:byt>
1 get_fgt_collapse(dta)    356µs    399µs     169KB
2 get_fgt_DT(copy(dta))    676µs    719µs     252KB



C:/Users/wb532966/eb-local/povspark/data-testing/sample_0001m 
# A tibble: 2 × 4
  expression                 min   median mem_alloc
  <bch:expr>            <bch:tm> <bch:tm> <bch:byt>
1 get_fgt_collapse(dta)    136ms    151ms     157MB
2 get_fgt_DT(copy(dta))    134ms    141ms     130MB



C:/Users/wb532966/eb-local/povspark/data-testing/sample_0005m 
# A tibble: 2 × 4
  expression                 min   median mem_alloc
  <bch:expr>            <bch:tm> <bch:tm> <bch:byt>
1 get_fgt_collapse(dta)    632ms    652ms     783MB
2 get_fgt_DT(copy(dta))    665ms    817ms     650MB
Processed 558 groups out of 558. 100% done. Time elapsed: 4s. ETA: 0s.
Processed 558 groups out of 558. 100% done. Time elapsed: 5s. ETA: 0s.
Processed 558 groups out of 558. 100% done. Time elapsed: 5s. ETA: 0s.
Processed 558 groups out of 558. 100% done. Time elapsed: 5s. ETA: 0s.



C:/Users/wb532966/eb-local/povspark/data-testing/sample_0050m 
# A tibble: 2 × 4
  expression                 min   median mem_alloc
  <bch:expr>            <bch:tm> <bch:tm> <bch:byt>
1 get_fgt_collapse(dta)    6.09s    6.29s    7.64GB
2 get_fgt_DT(copy(dta))    6.29s    6.32s    6.34GB
Processed 588 groups out of 588. 100% done. Time elapsed: 13s. ETA: 0s.
Processed 588 groups out of 588. 100% done. Time elapsed: 13s. ETA: 0s.
Processed 588 groups out of 588. 100% done. Time elapsed: 13s. ETA: 0s.
Processed 588 groups out of 588. 100% done. Time elapsed: 13s. ETA: 0s.



C:/Users/wb532966/eb-local/povspark/data-testing/sample_0150m 
# A tibble: 2 × 4
  expression                 min   median mem_alloc
  <bch:expr>            <bch:tm> <bch:tm> <bch:byt>
1 get_fgt_collapse(dta)    16.8s    17.4s    22.9GB
2 get_fgt_DT(copy(dta))    17.4s    17.4s      19GB

```